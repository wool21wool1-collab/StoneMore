<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>STONE MORE Smart Quotation (Deck Edition)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- html2canvas & jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Google Fonts (Pretendard) -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />

    <!-- EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-black': '#111111',
                        'brand-white': '#fcfcfc',
                        'brand-gray': '#444444',
                        'brand-blue': '#2563eb',
                        'brand-red': '#e11d48',
                    },
                    fontFamily: {
                        sans: ['Pretendard', 'sans-serif'],
                    }
                }
            }
        };
    </script>

    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        
        .capture-area { padding: 20px; background-color: white; flex: 1; position: relative; }
        @media (min-width: 1024px) { .capture-area { padding: 40px; } }

        .input-base {
            width: 100%; border: 1px solid #e5e7eb; padding: 10px 12px;
            border-radius: 6px; font-size: 14px; transition: all 0.2s; background-color: #fff;
        }
        .input-base:focus { outline: none; border-color: #111111; box-shadow: 0 0 0 2px rgba(17,17,17,0.1); }
        
        .table-wrapper {
            overflow-x: auto; -webkit-overflow-scrolling: touch;
            margin-bottom: 1rem; border: 1px solid #e5e7eb; border-radius: 8px;
        }
        .excel-table { width: 100%; min-width: 900px; border-collapse: collapse; font-size: 13px; }
        .excel-table th {
            background-color: #f8fafc; color: #475569; border-bottom: 2px solid #e2e8f0;
            padding: 12px 8px; font-weight: 700; text-align: center; white-space: nowrap;
        }
        .excel-table td { border-bottom: 1px solid #f1f5f9; padding: 6px; vertical-align: middle; }

        .excel-input {
            width: 100%; padding: 6px; border: 1px solid transparent; border-radius: 4px;
            background: transparent; outline: none; transition: all 0.2s;
        }
        .excel-input:focus { background-color: white; border-color: #cbd5e1; }

        .section-header {
            background: linear-gradient(to right, #111111, #333); color: white;
            padding: 12px 16px; font-weight: 700; font-size: 15px; margin-top: 24px;
            border-radius: 8px 8px 0 0; display: flex; align-items: center; justify-content: space-between;
        }

        .chk-wrap {
            display: flex; align-items: center; gap: 8px; font-size: 14px;
            cursor: pointer; padding: 6px 8px; border-radius: 6px; transition: bg 0.2s;
        }
        .chk-wrap:hover { background-color: #f9fafb; }
        .chk-wrap input[type="checkbox"] {
            appearance: none; width: 18px; height: 18px; border: 2px solid #d1d5db; border-radius: 4px;
            position: relative; cursor: pointer; transition: 0.2s;
        }
        .chk-wrap input[type="checkbox"]:checked { background-color: #111111; border-color: #111111; }
        .chk-wrap input[type="checkbox"]:checked::after {
            content: '✔'; color: white; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); font-size: 12px;
        }

        .btn-action {
            padding: 14px 28px; border-radius: 10px; font-weight: 700;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: all 0.2s; cursor: pointer; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        #pdf-hidden-container {
            position: fixed; left: 0; top: 0; width: 1600px; height: 0;
            overflow: visible; z-index: -9999; opacity: 0; pointer-events: none;
        }
        .pdf-mode .input-base, .pdf-mode .excel-input, .pdf-mode select, .pdf-mode textarea {
            border: none !important; background: transparent !important; box-shadow: none !important;
            padding: 0 !important; appearance: none; resize: none;
        }
        .pdf-mode .section-header { background: #111111 !important; color: white !important; -webkit-print-color-adjust: exact; margin-top: 10px !important; padding: 8px 12px !important; }
        .pdf-mode .capture-area { padding: 30px !important; max-width: 1600px !important; width: 100% !important; }
        
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #111111; border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 16px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .toast {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
            background: #111111; color: white; padding: 12px 24px; border-radius: 50px;
            font-size: 14px; font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 10001; opacity: 0; pointer-events: none; transition: opacity 0.3s, transform 0.3s;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(-10px); }
    </style>
</head>
<body class="bg-gray-100 py-4 px-2 md:py-8 md:px-4 text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 bg-white/90 z-[10000] hidden flex-col justify-center items-center backdrop-blur-sm">
        <div class="spinner"></div>
        <div class="text-xl font-bold text-gray-800" id="loading-text">처리 중...</div>
    </div>

    <div id="toast" class="toast">이메일이 발송되었습니다.</div>

    <nav class="w-full max-w-[1400px] mx-auto mb-6 bg-white p-4 rounded-xl shadow-sm flex flex-col md:flex-row justify-between items-center gap-4 text-brand-black">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-brand-black rounded-lg flex items-center justify-center text-white font-bold text-xl tracking-tighter">S</div>
            <div>
                <h1 class="text-xl font-bold leading-tight">STONE MORE Smart Quotation</h1>
                <p class="text-xs text-gray-500">프리미엄 데크 견적 시스템</p>
            </div>
        </div>
        <div class="flex bg-gray-100 p-1 rounded-lg w-full md:w-auto">
            <button onclick="switchTab(1)" id="nav-btn-1" class="flex-1 md:flex-none px-6 py-2.5 rounded-md text-sm font-bold shadow-sm bg-white text-brand-black transition-all">상담 시트</button>
            <button onclick="switchTab(2)" id="nav-btn-2" class="flex-1 md:flex-none px-6 py-2.5 rounded-md text-sm font-medium text-gray-500 hover:text-brand-black transition-all">견적서 작성</button>
        </div>
        <div class="flex gap-2">
            <button onclick="saveData(true)" class="text-xs font-medium text-gray-500 hover:text-blue-600 px-3 py-2 border rounded hover:bg-blue-50 transition-colors">저장</button>
            <button onclick="resetData()" class="text-xs font-medium text-gray-500 hover:text-red-600 px-3 py-2 border rounded hover:bg-red-50 transition-colors">초기화</button>
        </div>
    </nav>

    <main class="w-full max-w-[1400px] mx-auto bg-white rounded-xl shadow-sm overflow-hidden min-h-[800px] relative">
        
        <div id="page-1" class="fade-in">
            <div id="capture-area-1" class="capture-area">
                <div class="flex flex-col md:flex-row justify-between items-end border-b-4 border-black pb-6 mb-8 gap-4">
                    <div>
                        <h2 class="text-4xl font-extrabold text-brand-black tracking-tight uppercase">Consultation Sheet</h2>
                        <p class="text-gray-500 mt-2 font-medium">스톤모어 프리미엄 데크 솔루션 상담 기록</p>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-gray-500 mb-1 font-bold">Date</div>
                        <div id="view-date-1" class="font-bold text-2xl text-brand-black tabular-nums"></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
                    <div class="lg:col-span-4 space-y-8 lg:border-r lg:border-gray-100 lg:pr-8">
                        <section>
                            <h3 class="font-bold text-lg mb-4 flex items-center gap-2"><span class="w-1.5 h-6 bg-brand-black rounded-full"></span>담당자 정보</h3>
                            <div class="space-y-4 bg-gray-50 p-5 rounded-lg border border-gray-100">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-1.5 uppercase tracking-wide">Branch / 지사</label>
                                    <select id="branch-select" class="input-base" onchange="handleBranchChange()">
                                        <option value="">지사 선택</option>
                                        <option value="본사">본사</option>
                                        <option value="강북지사">강북지사</option>
                                        <option value="강남지사">강남지사</option>
                                        <option value="경상지사">경상지사</option>
                                        <option value="전라(제주)지사">전라(제주)지사</option>
                                        <option value="직접입력">직접 입력</option>
                                    </select>
                                    <input type="text" id="branch-input" class="input-base mt-2 hidden" placeholder="지사명 입력">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-1.5 uppercase tracking-wide">Manager / 담당자</label>
                                    <input type="text" id="handler-name" class="input-base" placeholder="담당자 성함">
                                </div>
                            </div>
                        </section>

                        <section>
                            <h3 class="font-bold text-lg mb-4 flex items-center gap-2"><span class="w-1.5 h-6 bg-brand-black rounded-full"></span>고객 정보</h3>
                            <div class="space-y-3">
                                <div class="grid grid-cols-3 gap-2 items-center">
                                    <span class="text-sm font-bold text-gray-600">고객명</span>
                                    <input type="text" id="cust-name" class="input-base col-span-2" placeholder="성함 입력">
                                </div>
                                <div class="grid grid-cols-3 gap-2 items-center">
                                    <span class="text-sm font-bold text-gray-600">연락처</span>
                                    <input type="tel" id="cust-phone" class="input-base col-span-2" placeholder="010-0000-0000">
                                </div>
                                <div class="grid grid-cols-3 gap-2 items-start pt-2">
                                    <span class="text-sm font-bold text-gray-600 mt-2">주소</span>
                                    <div class="col-span-2 space-y-2">
                                        <div class="grid grid-cols-2 gap-2">
                                            <select id="region-do" class="input-base"><option value="">시/도</option></select>
                                            <select id="region-si" class="input-base" disabled><option value="">시/군/구</option></select>
                                        </div>
                                        <input type="text" id="cust-addr-detail" class="input-base" placeholder="상세주소">
                                    </div>
                                </div>
                            </div>
                        </section>
                    </div>

                    <div class="lg:col-span-8 space-y-8">
                        <section>
                            <h3 class="font-bold text-lg mb-4 flex items-center gap-2"><span class="w-1.5 h-6 bg-brand-black rounded-full"></span>견적 기본 설정</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-8">
                                <div>
                                    <h4 class="text-xs font-bold text-gray-500 mb-3 uppercase bg-gray-100 p-2 rounded inline-block">상담 경로</h4>
                                    <div class="grid grid-cols-2 gap-1">
                                        <label class="chk-wrap"><input type="checkbox"> 유선 상담</label>
                                        <label class="chk-wrap"><input type="checkbox"> 현장 방문</label>
                                        <label class="chk-wrap"><input type="checkbox"> 쇼룸 내방</label>
                                        <label class="chk-wrap"><input type="checkbox"> 박람회</label>
                                        <label class="chk-wrap"><input type="checkbox"> 지인 소개</label>
                                        <label class="chk-wrap"><input type="checkbox"> 기타</label>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="text-xs font-bold text-gray-500 mb-3 uppercase bg-gray-100 p-2 rounded inline-block">고객 유형</h4>
                                    <div class="grid grid-cols-2 gap-1">
                                        <label class="chk-wrap"><input type="checkbox"> B2C (일반)</label>
                                        <label class="chk-wrap"><input type="checkbox"> B2B (기업)</label>
                                        <label class="chk-wrap"><input type="checkbox"> B2G (관공서)</label>
                                        <label class="chk-wrap"><input type="checkbox"> B2D (대리점)</label>
                                    </div>
                                </div>
                                <div class="md:col-span-2">
                                    <h4 class="text-xs font-bold text-gray-500 mb-3 uppercase bg-gray-100 p-2 rounded inline-block">납품 방식</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-1">
                                        <label class="chk-wrap"><input type="checkbox" class="delivery-chk"> 시공 일체 (완공 조건)</label>
                                        <label class="chk-wrap"><input type="checkbox" class="delivery-chk"> 자재 납품 (스톤데크 단품)</label>
                                        <label class="chk-wrap"><input type="checkbox" class="delivery-chk"> 자재 납품 (페데스탈 단품)</label>
                                        <label class="chk-wrap"><input type="checkbox" class="delivery-chk"> 자재 납품 (스톤 + 페데스탈 일체)</label>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <section class="flex-grow flex flex-col">
                            <h3 class="font-bold text-lg mb-4 flex items-center gap-2"><span class="w-1.5 h-6 bg-brand-black rounded-full"></span>상담 메모</h3>
                            <textarea id="consult-memo" class="w-full h-48 p-6 bg-[#fffdeb] border border-yellow-200 rounded-lg resize-none focus:ring-2 focus:ring-yellow-400 focus:outline-none text-sm leading-relaxed" placeholder="상세 요청사항을 기록하세요."></textarea>
                        </section>
                    </div>
                </div>

                <div class="mt-12 pt-8 border-t border-gray-200">
                    <h4 class="font-bold text-sm text-gray-900 mb-3 uppercase">[가견적 유의사항]</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2 text-[11px] text-gray-500 leading-relaxed">
                        <p><span class="font-bold text-gray-700">• 가견적 안내:</span> 본 견적서는 상담 편의를 위한 가견적이며 실측 후 변동될 수 있습니다.</p>
                        <p><span class="font-bold text-gray-700">• 산출 기준:</span> 시공 면적($m^2$) 기준으로 산출되며 단가에는 부자재가 포함되어 있습니다.</p>
                        <p><span class="font-bold text-gray-700">• 결제 조건:</span> 자재비 완납 조건이며 시공비는 종료 후 즉시 지급입니다. (VAT 별도)</p>
                        <p><span class="font-bold text-gray-700">• 별도 공사:</span> 바닥 기초 보강 및 전기 인입 등은 별도 사항입니다.</p>
                    </div>
                </div>
                <div class="absolute bottom-6 right-8 text-brand-black font-black text-5xl opacity-5 pointer-events-none tracking-tighter uppercase">STONE MORE</div>
            </div>
        </div>

        <div id="page-2" class="hidden fade-in">
            <div id="capture-area-2" class="capture-area">
                <div class="flex flex-col md:flex-row justify-between items-start mb-8 pb-6 border-b-2 border-brand-black gap-4">
                    <div>
                        <span class="text-xs font-bold text-brand-blue tracking-[0.2em] uppercase mb-1 block">Premium Deck Solution</span>
                        <h1 class="text-4xl md:text-5xl font-black text-brand-black tracking-tight uppercase">QUOTATION</h1>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-bold text-gray-500 font-bold">Estimate Date</div>
                        <div id="view-date-2" class="text-2xl font-bold text-brand-black tabular-nums"></div>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row border border-gray-300 rounded-lg overflow-hidden mb-10 text-sm">
                    <div class="w-full md:w-1/2 p-6 border-b md:border-b-0 md:border-r border-gray-300 bg-white">
                        <h3 class="font-bold text-gray-400 mb-4 text-xs uppercase tracking-wider">Supplier (공급자)</h3>
                        <dl class="grid grid-cols-[80px_1fr] gap-y-3">
                            <dt class="text-gray-500">상호</dt><dd class="font-bold text-lg text-gray-900">STONE MORE</dd>
                            <dt class="text-gray-500">담당자</dt><dd id="est-handler" class="font-medium">-</dd>
                            <dt class="text-gray-500">연락처</dt><dd class="font-medium">1800-5945</dd>
                        </dl>
                    </div>
                    <div class="w-full md:w-1/2 p-6 bg-gray-50/50">
                        <h3 class="font-bold text-gray-400 mb-4 text-xs uppercase tracking-wider">Customer (발주자)</h3>
                        <dl class="grid grid-cols-[80px_1fr] gap-y-3">
                            <dt class="text-gray-500">성함</dt><dd id="est-cust-name" class="font-bold text-lg text-gray-900">-</dd>
                            <dt class="text-gray-500">연락처</dt><dd id="est-cust-phone" class="font-medium">-</dd>
                            <dt class="text-gray-500">현장주소</dt><dd id="est-cust-addr" class="font-medium break-keep">-</dd>
                        </dl>
                    </div>
                </div>

                <div class="section-header">
                    <span>1. 제품 상세 내역 (Product Details)</span>
                    <div class="flex items-center gap-4 bg-white/10 px-4 py-1.5 rounded-lg border border-white/20">
                        <span class="text-xs font-medium text-white/80">총 시공 면적:</span>
                        <div class="flex items-center gap-1">
                            <input type="number" id="base-area" class="w-16 bg-transparent text-right font-bold text-white focus:outline-none border-b border-white/40" value="0" oninput="syncAreaToRows()">
                            <span class="text-xs text-white/80">$m^2$</span>
                        </div>
                    </div>
                </div>
                <div class="mb-8">
                    <div class="table-wrapper">
                        <table class="excel-table">
                            <colgroup><col width="50"><col width="220"><col width="160"><col width="100"><col width="140"><col width="60"><col width="80"><col width="110"><col width="130"><col width="50" class="hidden-on-print"></colgroup>
                            <thead>
                                <tr><th>No</th><th>품명</th><th>규격</th><th>색상</th><th>비고</th><th>단위</th><th>수량</th><th>단가</th><th>공급가액</th><th class="hidden-on-print">삭제</th></tr>
                            </thead>
                            <tbody id="est-tbody"></tbody>
                        </table>
                    </div>
                    <button onclick="addRow()" class="hidden-on-print w-full py-3 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 font-bold text-sm hover:border-brand-blue hover:text-brand-blue transition-all flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        데크/자재 항목 추가
                    </button>
                </div>

                <div class="section-header">2. 운임 및 부대비용</div>
                <div class="mb-8">
                    <div class="table-wrapper">
                        <table class="excel-table">
                            <colgroup><col width="150"><col width="200"><col width="200"><col width="60"><col width="80"><col width="110"><col width="130"><col width="50" class="hidden-on-print"></colgroup>
                            <thead>
                                <tr><th>구분</th><th>항목명</th><th>상세내용</th><th>단위</th><th>수량</th><th>단가</th><th>공급가액</th><th class="hidden-on-print">삭제</th></tr>
                            </thead>
                            <tbody id="cons-tbody"></tbody>
                        </table>
                    </div>
                    <div class="hidden-on-print grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-2">
                        <button onclick="addConsRow({cat:'직접시공비', name:'시공비', spec:'표준 시공', price:30000})" class="py-2.5 px-2 rounded border border-blue-200 bg-blue-50 text-brand-blue font-bold text-[11px] hover:bg-blue-100 transition-colors">+ 시공비 추가</button>
                        <button onclick="addConsRow({cat:'자재 반입비', name:'자재 반입비', spec:'현장 반입비', price:0})" class="py-2.5 px-2 rounded border border-indigo-200 bg-indigo-50 text-indigo-700 font-bold text-[11px] hover:bg-indigo-100 transition-colors">+ 자재 반입비 추가</button>
                        <button onclick="addConsRow({cat:'자재 반입비', name:'운임', spec:'화물비', price:0})" class="py-2.5 px-2 rounded border border-green-200 bg-green-50 text-green-700 font-bold text-[11px] hover:bg-green-100 transition-colors">+ 운임 추가</button>
                        <button onclick="addConsRow({cat:'자재 반입비', name:'양중비', spec:'사다리차/스카이', price:300000})" class="py-2.5 px-2 rounded border border-orange-200 bg-orange-50 text-orange-700 font-bold text-[11px] hover:bg-orange-100 transition-colors">+ 양중비 추가</button>
                        <button onclick="addConsRow({cat:'기타 비용', name:'폐기물 처리비', spec:'폐자재 처리', price:0})" class="py-2.5 px-2 rounded border border-red-200 bg-red-50 text-red-700 font-bold text-[11px] hover:bg-red-100 transition-colors">+ 폐기물 처리비 추가</button>
                        <button onclick="addConsRow()" class="py-2.5 px-2 rounded border border-gray-200 bg-white text-gray-700 font-bold text-[11px] hover:bg-gray-50 transition-colors">+ 기타 항목</button>
                    </div>
                </div>

                <div class="flex flex-col lg:flex-row gap-8">
                    <div class="w-full lg:w-2/3">
                        <div class="border border-gray-300 rounded-lg p-5 h-full bg-white shadow-sm">
                            <h4 class="text-xs font-bold text-gray-400 mb-3 uppercase tracking-wider">Note / Remarks (특이사항)</h4>
                            <textarea id="remarks-area" class="w-full h-32 text-sm resize-none focus:outline-none leading-relaxed text-gray-700" placeholder="납기 희망일 등을 입력하세요."></textarea>
                        </div>
                    </div>
                    <div class="w-full lg:w-1/3">
                        <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                            <table class="w-full text-sm">
                                <tr class="text-gray-500"><td class="py-1">제품 합계</td><td class="text-right tabular-nums" id="val-prod-sum">0</td></tr>
                                <tr class="text-gray-500 border-b border-gray-200"><td class="py-1 pb-3">시공/부대 합계</td><td class="text-right pb-3 tabular-nums" id="val-cons-sum">0</td></tr>
                                <tr class="text-brand-black font-bold"><td class="py-3 text-base">총 공급가액</td><td class="text-right tabular-nums text-base" id="val-supply">0</td></tr>
                                <tr class="text-gray-500 border-b border-gray-200"><td class="py-2 pb-4">부가세 (VAT 10%)</td><td class="text-right pb-4 tabular-nums" id="val-tax">0</td></tr>
                                <tr class="text-brand-black"><td class="pt-4 text-lg font-extrabold">총 견적금액</td><td class="pt-4 text-right text-3xl font-black text-brand-red tracking-tight tabular-nums">₩ <span id="val-total">0</span></td></tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="sticky bottom-0 bg-white/95 backdrop-blur border-t border-gray-200 p-4 flex justify-center gap-4 z-50">
            <div id="footer-page-1" class="w-full flex justify-center">
                <button onclick="switchTab(2)" class="btn-action bg-brand-black text-white hover:bg-gray-800 w-full md:w-auto min-w-[200px] text-lg shadow-lg">견적 산출하기 ▶</button>
            </div>
            <div id="footer-page-2" class="w-full hidden justify-center gap-4">
                <button onclick="switchTab(1)" class="btn-action bg-white border border-gray-300 text-gray-700 hover:bg-gray-50">상담 시트</button>
                <button onclick="saveAsPDF()" class="btn-action bg-brand-black text-white shadow-lg hover:bg-gray-800">PDF 저장 및 전송</button>
            </div>
        </div>
    </main>
    
    <div id="pdf-hidden-container"></div>

    <script>
        // --- 1. 초기 정보 및 EmailJS 설정 ---
        const EMAILJS_PUBLIC_KEY = "Wee5GwKPwshYQEFty"; 
        const EMAILJS_SERVICE_ID = "service_efdgi65"; 
        const EMAILJS_TEMPLATE_ID = "template_yqv4y4a"; 

        if (EMAILJS_PUBLIC_KEY) emailjs.init(EMAILJS_PUBLIC_KEY);

        const regions = {'서울특별시':['강남구','강동구','강북구','강서구','관악구','광진구','구로구','금천구','노원구','도봉구','동대문구','동작구','마포구','서대문구','서초구','성동구','성북구','송파구','양천구','영등포구','용산구','은평구','종로구','중구','중랑구'],'부산광역시':['강서구','금정구','기장군','남구','동구','동래구','부산진구','북구','사상구','사하구','서구','수영구','연제구','영도구','중구','해운대구'],'대구광역시':['군위군','남구','달서구','달성군','동구','북구','서구','수성구','중구'],'인천광역시':['강화군','계양구','남동구','동구','미추홀구','부평구','서구','연수구','옹진군','중구'],'광주광역시':['광산구','남구','동구','북구','서구'],'대전광역시':['대덕구','동구','서구','유성구','중구'],'울산광역시':['남구','동구','북구','울주군','중구'],'세종특별자치시':['세종시'],'경기도':['가평군','고양시','과천시','광명시','광주시','구리시','군포시','김포시','남양주시','동두천시','부천시','성남시','수원시','시흥시','안산시','안성시','안양시','양주시','양평군','여주시','연천군','오산시','용인시','의왕시','의정부시','이천시','파주시','평택시','포천시','하남시','화성시'],'강원특별자치도':['강릉시','고성군','동해시','삼척시','속초시','양구군','양양군','영월군','원주시','인제군','정선군','철원군','춘천시','태백시','평창군','홍천군','화천군','횡성군'],'충청북도':['괴산군','단양군','보은군','영동군','옥천군','음성군','제천시','증평군','진천군','청주시','충주시'],'충청남도':['계룡시','공주시','금산군','논산시','당진시','보령시','부여군','서산시','서천군','아산시','예산군','천안시','청양군','태안군','홍성군'],'전북특별자치도':['고창군','군산시','김제시','남원시','무주군','부안군','순창군','완주군','익산시','임실군','장수군','전주시','정읍시','진안군'],'전라남도':['강진군','고흥군','곡성군','광양시','구례군','나주시','담양군','목포시','무안군','보성군','순천시','신안군','여수시','영광군','영암군','완도군','장성군','장흥군','진도군','함평군','해남군','화순군'],'경상북도':['경산시','경주시','고령군','구미시','김천시','문경시','봉화군','상주시','성주군','안동시','영덕군','영양군','영주시','연천시','예천군','울릉군','울진군','의성군','청도군','청송군','칠곡군','포항시'],'경상남도':['거제시','거창군','고성군','김해시','남해군','밀양시','사천시','산청군','양산시','의령군','진주시','창녕군','창원시','통영시','하동군','함안군','함양군','합천군'],'제주특별자치도':['서귀포시','제주시']};

        const productGroups = [
            { category: "Stone Deck", items: [
                { name: "Stone Deck (엔조)", spec: "600*600", price: 30000, colors: ["센드", "신더", "코울"] },
                { name: "Stone Deck (체포스톤)", spec: "600*600", price: 30000, colors: ["라이트", "미디엄", "다크"] },
                { name: "Stone Deck (쿼라조)", spec: "600*600", price: 30000, colors: ["실버페럴", "바살트블랙"] },
                { name: "Stone Deck (라군)", spec: "600*600", price: 30000, colors: ["신더", "그레파트", "코울"] }
            ]},
            { category: "Pedestal", items: [
                { name: "Pedestal (SM-Base)", spec: "0~3mm", price: 1600 },
                { name: "Pedestal (SM-T0A)", spec: "19~30mm", price: 6000 },
                { name: "Pedestal (SM-T0B)", spec: "28~42mm", price: 8000 },
                { name: "Pedestal (SM-T0C)", spec: "40~65mm", price: 8800 },
                { name: "Pedestal (SM-T0D)", spec: "60~105mm", price: 10000 },
                { name: "Pedestal (SM-T0E)", spec: "90~185mm", price: 12400 },
                { name: "Pedestal (SM-T0F)", spec: "185~320mm", price: 17600 }
            ]},
            { category: "Etc", items: [
                { name: "첼판 마감", spec: "길이(m)", price: 30000, unit: "m" },
                { name: "각관 시공", spec: "면적(m2)", price: 70000, unit: "m2" }
            ]}
        ];

        const STORAGE_KEY = 'stonemore_deck_quote_v4_final';
        let autoSaveTimer = null;

        // --- 2. 초기화 로직 ---
        document.addEventListener('DOMContentLoaded', () => {
            initDate();
            initRegions();
            loadData() || initDefaultRows();
            setupAutoSave();
            switchTab(1);
        });

        function setupAutoSave() {
            document.querySelectorAll('input, select, textarea').forEach(el => {
                el.addEventListener('input', () => {
                    clearTimeout(autoSaveTimer);
                    autoSaveTimer = setTimeout(saveData, 1500);
                });
            });
        }

        function initDate() {
            const today = new Date().toLocaleDateString('ko-KR', { year:'numeric', month:'2-digit', day:'2-digit' });
            document.getElementById('view-date-1').textContent = today;
            document.getElementById('view-date-2').textContent = today;
        }

        function initRegions() {
            const doSelect = document.getElementById('region-do');
            let opts = '<option value="">시/도 선택</option>';
            Object.keys(regions).forEach(r => opts += `<option value="${r}">${r}</option>`);
            doSelect.innerHTML = opts;
            doSelect.addEventListener('change', function() {
                const siSelect = document.getElementById('region-si');
                const val = this.value;
                if(val && regions[val]) {
                    let sOpts = '<option value="">시/군/구 선택</option>';
                    regions[val].forEach(s => sOpts += `<option value="${s}">${s}</option>`);
                    siSelect.innerHTML = sOpts;
                    siSelect.disabled = false;
                } else {
                    siSelect.innerHTML = '<option value="">시/군/구</option>';
                    siSelect.disabled = true;
                }
                updateRegionCosts(val);
                saveData();
            });
        }

        function updateRegionCosts(region) {
            let freight = 300000;
            if (region.includes('제주')) freight = 1500000;
            else if (['경상','전라','강원'].some(k=>region.includes(k))) freight = 500000;

            document.querySelectorAll('#cons-tbody tr').forEach(r => {
                const nameInp = r.querySelector('td:nth-child(2) input');
                if(nameInp && nameInp.value.trim() === '운임') {
                    r.querySelector('.c-price').value = freight;
                    calcCons(r.querySelector('.c-price'));
                }
            });
        }

        function initDefaultRows() {
            addRow();
            addConsRow({ cat: "직접시공비", name: "시공비", spec: "표준 시공", price: 30000 });
            addConsRow({ cat: "자재 반입비", name: "운임", spec: "화물비", price: 0 });
            addConsRow({ cat: "자재 반입비", name: "양중비", spec: "사다리차/스카이", price: 300000 });
        }

        function switchTab(num) {
            const p1 = document.getElementById('page-1'), p2 = document.getElementById('page-2');
            const n1 = document.getElementById('nav-btn-1'), n2 = document.getElementById('nav-btn-2');
            const f1 = document.getElementById('footer-page-1'), f2 = document.getElementById('footer-page-2');

            if (num === 1) {
                p1.classList.remove('hidden'); p2.classList.add('hidden');
                f1.classList.remove('hidden'); f2.classList.add('hidden');
                n1.className = "flex-1 md:flex-none px-6 py-2.5 rounded-md text-sm font-bold shadow-sm bg-white text-brand-black transition-all";
                n2.className = "flex-1 md:flex-none px-6 py-2.5 rounded-md text-sm font-medium text-gray-500 hover:text-brand-black transition-all";
            } else {
                syncCustomerInfo();
                p1.classList.add('hidden'); p2.classList.remove('hidden');
                f1.classList.add('hidden'); f2.classList.remove('hidden'); f2.classList.add('flex');
                n2.className = "flex-1 md:flex-none px-6 py-2.5 rounded-md text-sm font-bold shadow-sm bg-white text-brand-black transition-all";
                n1.className = "flex-1 md:flex-none px-6 py-2.5 rounded-md text-sm font-medium text-gray-500 hover:text-brand-black transition-all";
            }
            window.scrollTo(0, 0);
        }

        function handleBranchChange() {
            document.getElementById('branch-input').classList.toggle('hidden', document.getElementById('branch-select').value !== '직접입력');
            saveData();
        }

        function syncCustomerInfo() {
            const name = document.getElementById('cust-name').value;
            const phone = document.getElementById('cust-phone').value;
            const rDo = document.getElementById('region-do').value, rSi = document.getElementById('region-si').value, rDet = document.getElementById('cust-addr-detail').value;
            
            document.getElementById('est-cust-name').textContent = name || '고객님';
            document.getElementById('est-cust-phone').textContent = phone || '-';
            document.getElementById('est-cust-addr').textContent = `${rDo} ${rSi} ${rDet}`.trim() || '-';
            
            const branchVal = document.getElementById('branch-select').value;
            const branch = branchVal === '직접입력' ? document.getElementById('branch-input').value : branchVal;
            const handler = document.getElementById('handler-name').value;
            document.getElementById('est-handler').textContent = `${branch} ${handler}`.trim() || '-';
        }

        function formatNumber(num) { return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
        function parseNum(str) { return parseFloat(String(str).replace(/,/g, '')) || 0; }

        function addRow() {
            const tbody = document.getElementById('est-tbody'), tr = document.createElement('tr');
            let prodOpts = '<option value="">품명 선택</option>';
            productGroups.forEach((group, gIdx) => {
                prodOpts += `<optgroup label="${group.category}">`;
                group.items.forEach((p, pIdx) => { prodOpts += `<option value="${gIdx}-${pIdx}">${p.name}</option>`; });
                prodOpts += `</optgroup>`;
            });
            
            tr.innerHTML = `
                <td><input type="tel" class="excel-input text-center"></td>
                <td><select class="excel-input" onchange="handleProdChange(this)">${prodOpts}</select></td>
                <td><input type="text" class="excel-input text-center spec-input" readonly></td>
                <td><select class="excel-input text-center color-select"><option value="-">-</option></select></td>
                <td><input type="text" class="excel-input" placeholder="비고"></td>
                <td><input type="text" class="excel-input text-center unit-input" value="m2" readonly></td>
                <td><input type="tel" class="excel-input text-center qty-input" value="1" oninput="calcRow(this)"></td>
                <td><input type="tel" class="excel-input text-right price-input" value="0" oninput="calcRow(this)"></td>
                <td class="text-right px-2 font-medium"><span class="sum-text">0</span></td>
                <td class="text-center hidden-on-print"><button onclick="this.closest('tr').remove(); calcTotal();" class="text-gray-400 font-bold px-2 hover:text-brand-red">×</button></td>
            `;
            tbody.appendChild(tr);
            syncAreaToRows();
        }

        function handleProdChange(sel) {
            const tr = sel.closest('tr');
            const val = sel.value; if (val === "") return;
            const [gIdx, pIdx] = val.split('-').map(Number);
            const p = productGroups[gIdx].items[pIdx];
            
            tr.querySelector('.spec-input').value = p.spec;
            tr.querySelector('.price-input').value = p.price;
            tr.querySelector('.unit-input').value = p.unit || "m2";
            
            const colorSel = tr.querySelector('.color-select');
            colorSel.innerHTML = "";
            if (p.colors) { p.colors.forEach(c => colorSel.innerHTML += `<option value="${c}">${c}</option>`); }
            else { colorSel.innerHTML = `<option value="-">-</option>`; }
            syncAreaToRows();
        }

        function syncAreaToRows() {
            const area = parseNum(document.getElementById('base-area').value);
            document.querySelectorAll('#est-tbody tr').forEach(tr => {
                const unit = tr.querySelector('.unit-input').value;
                const prodName = tr.querySelector('td:nth-child(2) select').selectedOptions[0]?.text || "";

                if (unit === 'm2' || prodName.includes('각관 시공')) { tr.querySelector('.qty-input').value = area; }
                calcRow(tr.querySelector('.qty-input'));
            });

            document.querySelectorAll('#cons-tbody tr').forEach(tr => {
                const nameInp = tr.querySelector('td:nth-child(2) input');
                if (nameInp && nameInp.value.trim() === '시공비') {
                    tr.querySelector('.c-qty').value = area;
                    calcCons(tr.querySelector('.c-qty'));
                }
            });
        }

        function calcRow(el) {
            const tr = el.closest('tr');
            const qty = parseNum(tr.querySelector('.qty-input').value);
            const price = parseNum(tr.querySelector('.price-input').value);
            tr.querySelector('.sum-text').textContent = formatNumber(qty * price);
            calcTotal();
        }

        function addConsRow(item = {}) {
            const tbody = document.getElementById('cons-tbody'), tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="text" class="excel-input text-center" value="${item.cat||''}"></td>
                <td><input type="text" class="excel-input" value="${item.name||''}"></td>
                <td><input type="text" class="excel-input" value="${item.spec||''}"></td>
                <td><input type="text" class="excel-input text-center c-unit" value="식"></td>
                <td><input type="tel" class="excel-input text-center c-qty" value="1" oninput="calcCons(this)"></td>
                <td><input type="tel" class="excel-input text-right c-price" value="${item.price||0}" oninput="calcCons(this)"></td>
                <td class="text-right px-2 font-medium"><span class="c-sum">0</span></td>
                <td class="text-center hidden-on-print"><button onclick="this.closest('tr').remove(); calcTotal();" class="text-gray-400 font-bold px-2 hover:text-brand-red">×</button></td>
            `;
            tbody.appendChild(tr);
            if (item.name === '시공비') {
                const area = parseNum(document.getElementById('base-area').value);
                tr.querySelector('.c-qty').value = area;
            }
            calcCons(tr.querySelector('.c-qty'));
        }

        function calcCons(el) {
            const tr = el.closest('tr');
            tr.querySelector('.c-sum').textContent = formatNumber(parseNum(tr.querySelector('.c-qty').value) * parseNum(tr.querySelector('.c-price').value));
            calcTotal();
        }

        function calcTotal() {
            let prodSum = 0; document.querySelectorAll('#est-tbody .sum-text').forEach(s => prodSum += parseNum(s.textContent));
            let consSum = 0; document.querySelectorAll('#cons-tbody .c-sum').forEach(s => consSum += parseNum(s.textContent));
            const supply = prodSum + consSum, tax = Math.round(supply * 0.1);
            
            document.getElementById('val-prod-sum').textContent = formatNumber(prodSum);
            document.getElementById('val-cons-sum').textContent = formatNumber(consSum);
            document.getElementById('val-supply').textContent = formatNumber(supply);
            document.getElementById('val-tax').textContent = formatNumber(tax);
            document.getElementById('val-total').textContent = formatNumber(supply + tax);
        }

        function saveData(manual = false) {
            const data = {};
            document.querySelectorAll('input[id], select[id], textarea[id]').forEach(el => data[el.id] = el.value);
            const checks = [];
            document.querySelectorAll('#page-1 input[type="checkbox"]').forEach((chk, idx) => checks.push({ idx, checked: chk.checked }));
            data.checks = checks;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            if(manual) showToast('임시 저장되었습니다.');
        }

        function loadData() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if(!saved) return false;
                const data = JSON.parse(saved);
                for(const id in data) { if(id === 'checks') continue; const el = document.getElementById(id); if(el) el.value = data[id]; }
                if(data.checks) {
                    const checkboxes = document.querySelectorAll('#page-1 input[type="checkbox"]');
                    data.checks.forEach(c => { if(checkboxes[c.idx]) checkboxes[c.idx].checked = c.checked; });
                }
                syncCustomerInfo();
                setTimeout(() => calcTotal(), 500);
                return true;
            } catch(e) { return false; }
        }

        function resetData() {
            if(confirm("모든 데이터를 초기화하시겠습니까?")) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg; toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // --- 4. 인쇄 및 이메일 전송 최적화 (Span 변환 방식) ---
        async function saveAsPDF() {
            const overlay = document.getElementById('loading-overlay');
            const loadingText = document.getElementById('loading-text');
            overlay.classList.remove('hidden'); overlay.classList.add('flex');
            
            try {
                loadingText.textContent = "PDF 데이터 변환 중...";
                const hidden = document.getElementById('pdf-hidden-container');
                hidden.innerHTML = '';
                
                const clone1 = document.getElementById('capture-area-1').cloneNode(true);
                const clone2 = document.getElementById('capture-area-2').cloneNode(true);
                
                [clone1, clone2].forEach(node => {
                    node.querySelectorAll('input, select, textarea').forEach(el => {
                        const span = document.createElement('span');
                        if (el.type === 'checkbox') {
                            span.innerHTML = el.checked ? '&#9745;' : '&#9744;'; 
                            span.style.fontSize = '16px';
                        } else {
                            const val = el.tagName === 'SELECT' ? (el.options[el.selectedIndex]?.text || '') : el.value;
                            span.textContent = val;
                            span.style.fontWeight = '500';
                            if(el.tagName === 'TEXTAREA') {
                                span.style.whiteSpace = 'pre-wrap';
                                span.style.display = 'block';
                            }
                        }
                        el.parentNode.replaceChild(span, el);
                    });
                    node.querySelectorAll('button').forEach(b => b.remove());
                    node.classList.add('pdf-mode');
                });
                
                hidden.appendChild(clone1); hidden.appendChild(clone2);
                await new Promise(r => setTimeout(r, 500)); 

                const doc = new window.jspdf.jsPDF('p', 'mm', 'a4');
                const pageWidth = doc.internal.pageSize.getWidth();
                const captureOpts = { scale: 2, width: 1600, windowWidth: 1600 };

                loadingText.textContent = "PDF 페이지 생성 중 (1/2)...";
                const cvs1 = await html2canvas(clone1, captureOpts);
                const img1 = cvs1.toDataURL('image/jpeg', 0.95);
                const prop1 = doc.getImageProperties(img1);
                const pdfH1 = (prop1.height * pageWidth) / prop1.width;
                doc.addImage(img1, 'JPEG', 0, 0, pageWidth, pdfH1);

                loadingText.textContent = "PDF 페이지 생성 중 (2/2)...";
                doc.addPage();
                const cvs2 = await html2canvas(clone2, captureOpts);
                const img2 = cvs2.toDataURL('image/jpeg', 0.95);
                const prop2 = doc.getImageProperties(img2);
                const pdfH2 = (prop2.height * pageWidth) / prop2.width;
                doc.addImage(img2, 'JPEG', 0, 0, pageWidth, pdfH2);

                const name = document.getElementById('cust-name').value.trim() || 'VIP';
                const rSi = document.getElementById('region-si').value;
                const region = (rSi && rSi !== '시/군/구 선택') ? rSi : '상담';
                const d = new Date();
                const dateStr = `${d.getFullYear().toString().slice(-2)}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;
                const fileName = `STM_Quote_${name}_${region}_${dateStr}.pdf`;
                doc.save(fileName);
                
                loadingText.textContent = "이메일 발송 중...";
                await sendEmailJS();
                showToast('PDF 저장 및 전송이 완료되었습니다.');
                
            } catch (err) {
                console.error(err);
                showToast('처리 중 오류가 발생했습니다.');
            } finally { 
                overlay.classList.add('hidden');
                document.getElementById('pdf-hidden-container').innerHTML = '';
            }
        }

        async function sendEmailJS() {
            if (!EMAILJS_SERVICE_ID || !EMAILJS_TEMPLATE_ID) return;

            // 상세 내역 텍스트 빌드
            let detailsText = "=====================================\n";
            detailsText += "[1. 제품 상세 내역]\n";
            document.querySelectorAll('#est-tbody tr').forEach((tr, idx) => {
                const prod = tr.querySelector('td:nth-child(2) select')?.selectedOptions[0]?.text || "-";
                const spec = tr.querySelector('.spec-input')?.value || "-";
                const color = tr.querySelector('.color-select')?.value || "-";
                const qty = tr.querySelector('.qty-input')?.value || "0";
                const price = tr.querySelector('.price-input')?.value || "0";
                const sum = tr.querySelector('.sum-text')?.textContent || "0";
                if(prod !== "품명 선택") {
                    detailsText += `${idx+1}. ${prod} (${spec})\n   색상: ${color} | 수량: ${qty} | 단가: ${price} | 소계: ${sum}\n`;
                }
            });

            detailsText += "\n[2. 운임 및 부대비용]\n";
            document.querySelectorAll('#cons-tbody tr').forEach((tr) => {
                const cat = tr.querySelector('td:nth-child(1) input')?.value || "-";
                const name = tr.querySelector('td:nth-child(2) input')?.value || "-";
                const spec = tr.querySelector('td:nth-child(3) input')?.value || "-";
                const qty = tr.querySelector('.c-qty')?.value || "0";
                const price = tr.querySelector('.c-price')?.value || "0";
                const sum = tr.querySelector('.c-sum')?.textContent || "0";
                if(name !== "-") {
                    detailsText += `- [${cat}] ${name} (${spec})\n   수량: ${qty} | 단가: ${price} | 소계: ${sum}\n`;
                }
            });
            detailsText += "=====================================";

            const templateParams = {
                cust_name: document.getElementById('cust-name').value || '고객(미입력)',
                cust_phone: document.getElementById('cust-phone').value || '-',
                cust_addr: document.getElementById('est-cust-addr').textContent,
                base_area: document.getElementById('base-area').value,
                total_price: document.getElementById('val-total').textContent,
                handler_info: document.getElementById('est-handler').textContent,
                memo: document.getElementById('consult-memo').value,
                details: detailsText // 생성된 상세 내역 텍스트 전달
            };
            return emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);
        }
    </script>
</body>
</html>